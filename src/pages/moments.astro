---
import { Icon } from 'astro-icon/components'
import I18nKey from '../i18n/i18nKey'
import { i18n } from '../i18n/translation'
import MainGridLayout from '../layouts/MainGridLayout.astro'

const momentsData = await import('../content/moments/moments.json')
const moments = momentsData.default.sort((a: any, b: any) => 
  new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime()
)

function formatDateTime(timestamp: string) {
  const date = new Date(timestamp)
  
  return date.toLocaleDateString('zh-TW', { 
    year: 'numeric', 
    month: '2-digit', 
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit'
  })
}

function formatContent(content: string) {
  const codeBlockRegex = /```(\w+)?\n([\s\S]*?)```/g
  return content.replace(codeBlockRegex, (match, lang, code) => {
    return `<pre class="bg-gray-100 dark:bg-gray-800 rounded-lg p-3 my-2 overflow-x-auto"><code class="text-sm">${code.trim()}</code></pre>`
  })
}
---

<MainGridLayout title="一些生活的小碎片" description="分享一些碎碎念">
  <div class="max-w-2xl mx-auto">
    <div class="mb-8">
      <h1 class="text-3xl font-bold dark:text-white text-black mb-2">生活的小碎片</h1>
      <p class="text-gray-600 dark:text-gray-400">小小的碎碎念</p>
    </div>

    <!-- 動態列表 -->
    <div class="space-y-4">
      {moments.map((moment: any) => (
        <article 
          id={moment.id}
          class="bg-[var(--card-bg,#f5f5f5)] dark:bg-[var(--card-bg,#333)] rounded-2xl p-6 shadow-sm hover:shadow-md transition-all duration-200 border border-gray-200/50 dark:border-gray-700/50"
        >
          <!-- 用戶信息頭部 -->
          <div class="flex items-center mb-4">
            <img 
              src={moment.author.avatar} 
              alt={moment.author.name}
              class="w-12 h-12 rounded-full object-cover"
            />
            <div class="ml-3 flex-grow">
              <div class="flex items-center gap-2">
                <h3 class="font-semibold dark:text-white text-black">
                  {moment.author.name}
                </h3>
                <div class="w-1 h-1 bg-gray-400 rounded-full"></div>
                <time class="text-sm text-gray-500 dark:text-gray-400">
                  {formatDateTime(moment.timestamp)}
                </time>
              </div>
            </div>
          </div>

          <!-- 內容 -->
          <div 
            class="dark:text-white text-black leading-relaxed mb-4 whitespace-pre-wrap"
            set:html={formatContent(moment.content)}
          >
          </div>

          <!-- 標籤 -->
          {moment.tags && moment.tags.length > 0 && (
            <div class="flex flex-wrap gap-2 mb-4">
              {moment.tags.map((tag: string) => (
                <span class="px-3 py-1 text-sm bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-300 rounded-full">
                  #{tag}
                </span>
              ))}
            </div>
          )}

        </article>
      ))}
    </div>

  </div>
</MainGridLayout>

